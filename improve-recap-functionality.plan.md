# Улучшение функциональности Recap

**Status**: `complete`

## Problem Statement
Текущая реализация имеет три проблемы:
1. В рекап попадают все секции из шаблона, нужно дать пользователю контроль какие секции включать
2. Нельзя обновить отчёт за текущий день - плагин показывает ошибку если отчёт уже существует
3. Missing Days показывает все пропущенные дни без ограничения

## Questions Resolved
- Q: Какие заголовки должны быть в настройках по умолчанию для нового пользователя?
  A: Пустой список - пользователь сам выбирает нужные секции
- Q: Как должен обновляться отчёт за текущий день?
  A: Перезаписывать содержимое существующего файла

## Edge Cases & Considerations
- [x] Пользователь не указал ни одной секции → Показывать ошибку с просьбой настроить секции
- [x] Указанная секция не найдена в заметке → Пропускать эту секцию (не ошибка)
- [x] Заголовки с разными пробелами/регистром → Точное сравнение (case-sensitive)
- [x] Обновление отчёта за сегодня → Перезаписывать содержимое, имя файла сохранять
- [x] Файл отчёта был переименован/удалён вручную → Создавать новый файл
- [x] Missing days для длинного периода → Ограничить 3 неделями

## Relevant Context
- `src/domain/entities/PluginSettings.ts` - Настройки плагина
- `src/presentation/` - UI для настроек
- `src/domain/parsers/SectionExtractor.ts` - Логика извлечения секций
- `src/domain/services/MissingDaysService.ts` - Генерация Missing Days
- `src/application/useCases/GenerateRecapUseCase.ts` - Основная логика генерации
- `src/infrastructure/repositories/ReportRepository.ts` - Сохранение отчётов

## Feature Steps

- [x] **Добавление настройки для выбора секций**
  - **Business Value**: Пользователь сам контролирует какие секции попадают в рекап, работает с любыми шаблонами
  - **Depends on**: none
  - **Definition of Done**:
    - [x] В PluginSettings добавлено поле `includedSections: string[]` (пустой массив по умолчанию)
    - [x] В UI настроек добавлен текстовый input для ввода секций через запятую
    - [x] Сохранение/загрузка настроек работает корректно
  - **Touches**: `src/domain/entities/PluginSettings.ts`, `src/presentation/`

- [x] **Обновление логики извлечения секций**
  - **Business Value**: Извлекает только те секции, которые указал пользователь
  - **Depends on**: Добавление настройки для выбора секций
  - **Definition of Done**:
    - [x] SectionExtractor принимает список секций для извлечения
    - [x] Извлекаются только секции с указанными заголовками (## уровень)
    - [x] Если секция не найдена - пропускается без ошибки
    - [x] Проверка что список секций не пустой, иначе ошибка
  - **Touches**: `src/domain/parsers/SectionExtractor.ts`, `src/application/useCases/GenerateRecapUseCase.ts`

- [x] **Обновление логики генерации отчётов за текущий день**
  - **Business Value**: Позволяет обновлять отчёт в течение дня по мере внесения изменений
  - **Depends on**: none
  - **Definition of Done**:
    - [x] Убрана проверка на существование отчёта за сегодня
    - [x] Если отчёт за сегодня существует - обновить его содержимое
    - [x] Если отчёта нет - создать новый
    - [x] Обновление lastReport в настройках при перезаписи
  - **Touches**: `src/main.ts`, `src/application/useCases/GenerateRecapUseCase.ts`, `src/infrastructure/repositories/ReportRepository.ts`

- [x] **Ограничение Missing Days тремя неделями**
  - **Business Value**: Избегает огромных списков пропущенных дней для длинных периодов
  - **Depends on**: none
  - **Definition of Done**:
    - [x] MissingDaysService или ReportGeneratorService ограничивает вывод 3 неделями
    - [x] Если период больше 3 недель - показывать только последние 21 день
  - **Touches**: `src/domain/services/MissingDaysService.ts` или `src/domain/services/ReportGeneratorService.ts`

## Testing Strategy
- **Unit тесты**:
  - Тест извлечения только указанных секций
  - Тест обработки пустого списка секций (ошибка)
  - Тест обработки отсутствующей секции (пропуск)
  - Тест обновления существующего отчёта
  - Тест ограничения Missing Days (3 недели)
- **Ручное тестирование** пользователем на реальном vault после реализации

## Notes
- При обновлении отчёта за_today_ имя файла должно оставаться тем же (Recap_YYYY-MM-DD_HH-mm.md)
- Missing Days - это информационная секция, ограничения не должны влиять на данные отчёта
